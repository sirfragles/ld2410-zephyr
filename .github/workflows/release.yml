name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    name: Verify Tests Pass
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          path: ld2410

      - name: Set up Zephyr workspace
        uses: zephyrproject-rtos/action-zephyr-setup@v1
        with:
          app-path: ld2410
          toolchains: arm-zephyr-eabi
          sdk-version: "0.16.8"
          west-group-filter: "-optional"

      - name: Run protocol tests
        run: |
          west twister \
            -T ld2410/tests \
            -p native_sim

  build-firmware:
    name: Build Release Firmware
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          path: ld2410

      - name: Set up Zephyr workspace
        uses: zephyrproject-rtos/action-zephyr-setup@v1
        with:
          app-path: ld2410
          toolchains: arm-zephyr-eabi
          sdk-version: "0.16.8"
          west-group-filter: "-optional"

      - name: Build sample for xiao_ble
        run: west build -b xiao_ble ld2410/samples/basic

      - name: Rename firmware for release
        run: |
          cp build/zephyr/zephyr.hex \
            build/zephyr/ld2410-sample-xiao_ble-${{ github.ref_name }}.hex

      - name: Upload firmware for release job
        uses: actions/upload-artifact@v4
        with:
          name: release-firmware
          path: build/zephyr/ld2410-sample-xiao_ble-${{ github.ref_name }}.hex

  create-release:
    name: Create GitHub Release
    needs: [test, build-firmware]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download firmware artifact
        uses: actions/download-artifact@v4
        with:
          name: release-firmware

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.hex"
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
