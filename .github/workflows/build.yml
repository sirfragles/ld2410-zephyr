name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs on the same branch/PR to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ZEPHYR_VERSION: v3.7.0
  ZEPHYR_SDK_VERSION: "0.16.8"
  ZEPHYR_CI_IMAGE: ghcr.io/zephyrproject-rtos/ci:v0.27.4

jobs:
  build:
    name: Build Sample (xiao_ble)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.27.4
    env:
      CMAKE_PREFIX_PATH: /opt/toolchains/zephyr-sdk-0.16.8
      ZEPHYR_TOOLCHAIN_VARIANT: zephyr

    steps:
      - name: Install west
        run: pip3 install west

      - name: Initialize Zephyr workspace
        run: |
          mkdir -p /workdir && cd /workdir
          west init --mr ${{ env.ZEPHYR_VERSION }}
          west update --narrow -o=--depth=1
          pip3 install -r zephyr/scripts/requirements.txt

      - uses: actions/checkout@v4
        with:
          path: /workdir/modules/lib/ld2410

      - name: Build sample for xiao_ble
        working-directory: /workdir
        run: |
          west build -b xiao_ble \
            modules/lib/ld2410/samples/basic \
            -- -DZEPHYR_EXTRA_MODULES=/workdir/modules/lib/ld2410

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: xiao_ble-firmware
          path: |
            /workdir/build/zephyr/zephyr.hex
            /workdir/build/zephyr/zephyr.elf
          retention-days: 30

  test:
    name: Protocol Tests (native_sim)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.27.4
    env:
      CMAKE_PREFIX_PATH: /opt/toolchains/zephyr-sdk-0.16.8
      ZEPHYR_TOOLCHAIN_VARIANT: zephyr

    steps:
      - name: Install west
        run: pip3 install west

      - name: Initialize Zephyr workspace
        run: |
          mkdir -p /workdir && cd /workdir
          west init --mr ${{ env.ZEPHYR_VERSION }}
          west update --narrow -o=--depth=1
          pip3 install -r zephyr/scripts/requirements.txt

      - uses: actions/checkout@v4
        with:
          path: /workdir/modules/lib/ld2410

      - name: Run protocol tests
        working-directory: /workdir
        run: |
          west twister \
            -T modules/lib/ld2410/tests \
            --extra-args ZEPHYR_EXTRA_MODULES=/workdir/modules/lib/ld2410 \
            -p native_sim \
            --output-dir twister-out

      - name: Upload twister results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: twister-results
          path: /workdir/twister-out/
          retention-days: 7

      - name: Publish test report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: /workdir/twister-out/**/twister.xml
          check_name: Protocol Test Results
          fail_on_failure: true
